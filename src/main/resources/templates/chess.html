<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Woowa Kingdom Chess</title>
    <link rel="stylesheet" type="text/css" href="css/chess.css">
</head>
<body>
<div id="total">
    <div id="top">
        <p>Woowa Kingdom Chess</p>
    </div>
    <div id="middle">
        <div id="chessboard-box">
            <div id="chessboard">
                <div id="a8" class="grid-item"></div>
                <div id="b8" class="grid-item"></div>
                <div id="c8" class="grid-item"></div>
                <div id="d8" class="grid-item"></div>
                <div id="e8" class="grid-item"></div>
                <div id="f8" class="grid-item"></div>
                <div id="g8" class="grid-item"></div>
                <div id="h8" class="grid-item"></div>

                <div id="a7" class="grid-item"></div>
                <div id="b7" class="grid-item"></div>
                <div id="c7" class="grid-item"></div>
                <div id="d7" class="grid-item"></div>
                <div id="e7" class="grid-item"></div>
                <div id="f7" class="grid-item"></div>
                <div id="g7" class="grid-item"></div>
                <div id="h7" class="grid-item"></div>

                <div id="a6" class="grid-item"></div>
                <div id="b6" class="grid-item"></div>
                <div id="c6" class="grid-item"></div>
                <div id="d6" class="grid-item"></div>
                <div id="e6" class="grid-item"></div>
                <div id="f6" class="grid-item"></div>
                <div id="g6" class="grid-item"></div>
                <div id="h6" class="grid-item"></div>

                <div id="a5" class="grid-item"></div>
                <div id="b5" class="grid-item"></div>
                <div id="c5" class="grid-item"></div>
                <div id="d5" class="grid-item"></div>
                <div id="e5" class="grid-item"></div>
                <div id="f5" class="grid-item"></div>
                <div id="g5" class="grid-item"></div>
                <div id="h5" class="grid-item"></div>

                <div id="a4" class="grid-item"></div>
                <div id="b4" class="grid-item"></div>
                <div id="c4" class="grid-item"></div>
                <div id="d4" class="grid-item"></div>
                <div id="e4" class="grid-item"></div>
                <div id="f4" class="grid-item"></div>
                <div id="g4" class="grid-item"></div>
                <div id="h4" class="grid-item"></div>

                <div id="a3" class="grid-item"></div>
                <div id="b3" class="grid-item"></div>
                <div id="c3" class="grid-item"></div>
                <div id="d3" class="grid-item"></div>
                <div id="e3" class="grid-item"></div>
                <div id="f3" class="grid-item"></div>
                <div id="g3" class="grid-item"></div>
                <div id="h3" class="grid-item"></div>

                <div id="a2" class="grid-item"></div>
                <div id="b2" class="grid-item"></div>
                <div id="c2" class="grid-item"></div>
                <div id="d2" class="grid-item"></div>
                <div id="e2" class="grid-item"></div>
                <div id="f2" class="grid-item"></div>
                <div id="g2" class="grid-item"></div>
                <div id="h2" class="grid-item"></div>

                <div id="a1" class="grid-item"></div>
                <div id="b1" class="grid-item"></div>
                <div id="c1" class="grid-item"></div>
                <div id="d1" class="grid-item"></div>
                <div id="e1" class="grid-item"></div>
                <div id="f1" class="grid-item"></div>
                <div id="g1" class="grid-item"></div>
                <div id="h1" class="grid-item"></div>
            </div>
        </div>
        <div id="status">
            <div class="score">
                <img src="./img/black_team.png">
                <p>
                    {{black-score}}
                </p>
            </div>
            <div id="turn">
                {{#if isWhite}}
                <img src="./img/white_turn.png">
                {{else}}
                <img src="./img/black_turn.png">
                {{/if}}
            </div>
            <div class="score">
                <img src="./img/white_team.png">
                <p>
                    {{white-score}}
                </p>
            </div>
            <div id="bottom">
                <form action="/" method="get">
                    <input type="submit" value="나가기">
                </form>
                <form action="start" method="post">
                    <input type="submit" value={{button}}>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script>


    // startPointCheck가 true인 경우,
    // 갈 수 있는 위치 리스트에 클릭한 좌표가 포함된다면,
    // startPoint와 endPoint를 move 요청하고, startPointCheck를 false로 바꾼다.

    let startPoint = "";
    let endPoint = "";
    let startPointCheck = false;

    // 우리 팀 차례의 말을 클릭하면
    $(".grid-item").click(function (event) {
        let element = event.target;
        if(element.tagName === "IMG") {
            element = element.parentNode;
        }
        const clickedSection = element.id;
        $.ajax({
            url: "/myTurn",
            data: {
                clickedSection : clickedSection
            },
            method: "POST",
            dataType: "json"
        }).done(function (turn) {
            getMovablePosition(clickedSection, turn);
        });
    });

    // 갈 수 있는 위치 리스트를 요청해서 받아오고, startPoint를 해당 좌표로 설정해주고, startPointCheck를 true로 바꿔준다.
    function getMovablePosition(clickedSection, turn) {
        if (turn) {
            $.ajax({
                url: "/movablePositions",
                data: {
                    clickedSection : clickedSection
                },
                method: "POST",
                dataType: "json"
            }).done(function (positions) {
                showMovablePositions(clickedSection, positions);
                startPoint = clickedSection;
                startPointCheck = true;
            });
        }
    }

    function showMovablePositions(clickedSection, positions) {
        const startPoint = document.getElementById(clickedSection);
        startPoint.classList.toggle("selected");
        const imgUrl = startPoint.children[0].src
        for (let i = 0; i < positions.length; i++) {
            const position = positions[i];
            const section = document.getElementById(position);
            section.style.backgroundImage = "url(" + imgUrl +")";
            section.classList.add("movable");
        }
    }
</script>
<script>
    {{#pieces}}
    document.getElementById("{{position}}")
        .insertAdjacentHTML("beforeend", "<img src=./img/pieces/{{team}}_{{initial}}.png>");
    {{/pieces}}
</script>
</body>
</html>